#!/bin/bash

# count-collisions from git-experiments
# https://github.com/rsp/git-experiments
# by RafaÅ‚ Pocztarski - https://github.com/rsp

# starting number of hash digits:
digits_min=1

# use --objects flag in git rev-list:
#objects="--objects"
objects=""

if [ $# -ne 1 ]; then
	echo "Usage:   $0 DIRECTORY" >&2
	echo "For CWD: $0 ."
	exit 1
fi

dir=$1
cd $dir || {
	echo "Cannot cd into '$dir'" >&2
	exit 2
}

url=`git config --get remote.origin.url`
if [ "$url" == "" ]; then
	echo "Cannot get git remote 'origin' in '$dir'" >&2
	exit 3
fi

hashes=`mktemp`
if [ "$hashes" == "" ]; then
	echo "Cannot create a temp file." >&2
	exit 3
fi

git rev-list --all $objects | cut -f 1 -d ' ' > $hashes

total=`cat $hashes | wc -l`

echo -e "Directory:\t$dir"
echo -e "Repository:\t$url"
echo -e "Total objects:\t$total"

digits=$digits_min
colliding=x

while [ "$colliding" != 0 ]; do
	unique=`cat $hashes | cut -c1-$digits | sort | uniq | wc -l`
	colliding=`cat $hashes | cut -c1-$digits | sort | uniq -D | wc -l`
	noncolliding=$(($total-$colliding))
	echo "Digits: $digits, Unique: $unique, Colliding: $colliding, Noncolliding: $noncolliding"
	digits=$(($digits+1))
done

rm $hashes
